<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<script id="jquery_183" type="text/javascript" class="library" src="/js/jquery-1.8.3.js"></script>
<style>
    /* Generated by less 2.1.1 */
    #container {
        display: block;
        width: 300px;
        height: 300px;
        border: 4px solid #333;
        margin: 0 auto;
    }
    #container .item {
        float: left;
        display: block;
        width: 73px;
        height: 73px;
        text-align: center;
        border: 1px solid #ccc;
        position: relative;
        z-index: 1;
    }
    #container .item > div {
        display: block;
        width: 73px;
        height: 73px;
        background-repeat: no-repeat;
        position: absolute;
        z-index: 10;
        top: 0;
        left: 0;
    }
    #container.level1 .item > div {
        background-image: url('http://sandbox.runjs.cn/uploads/rs/197/ra0svy9c/1.jpg');
    }
    #container.level2 .item > div {
        background-image: url('http://sandbox.runjs.cn/uploads/rs/197/ra0svy9c/2.jpg');
    }
    #container.level3 .item > div {
        background-image: url('http://sandbox.runjs.cn/uploads/rs/197/ra0svy9c/3.jpg');
    }
    #container.level4 .item > div {
        background-image: url('http://sandbox.runjs.cn/uploads/rs/197/ra0svy9c/4.jpg');
    }
    #container.level5 .item > div {
        background-image: url('http://sandbox.runjs.cn/uploads/rs/197/ra0svy9c/5.jpg');
    }
    #container .item > div.empty {
        z-index: 8;
        background: none !important;
    }
    .pos-0-0 {
        background-position: 0px 0px;
    }
    .pos-1-0 {
        background-position: -73px 0px;
    }
    .pos-2-0 {
        background-position: -146px 0px;
    }
    .pos-3-0 {
        background-position: -219px 0px;
    }
    .pos-0-1 {
        background-position: 0px -73px;
    }
    .pos-1-1 {
        background-position: -73px -73px;
    }
    .pos-2-1 {
        background-position: -146px -73px;
    }
    .pos-3-1 {
        background-position: -219px -73px;
    }
    .pos-0-2 {
        background-position: 0px -146px;
    }
    .pos-1-2 {
        background-position: -73px -146px;
    }
    .pos-2-2 {
        background-position: -146px -146px;
    }
    .pos-3-2 {
        background-position: -219px -146px;
    }
    .pos-0-3 {
        background-position: 0px -219px;
    }
    .pos-1-3 {
        background-position: -73px -219px;
    }
    .pos-2-3 {
        background-position: -146px -219px;
    }
    .pos-3-3 {
        background-position: -219px -219px;
    }

</style>
<body>
<a id="reset" href="#">重置</a>
<a id="prev" href="#">上一关</a>
<a id="next" href="#">下一关</a>
<script>
    ;
    (function(factory) {
        factory(jQuery);
    })(function($) {
        //容器
        var $container = $('<div id="container"></div>'),
            gridSize = 4, //格子高宽4*4
            empty = {}, //空格子位置
            maxLevel = 5, //关卡数量
            canClick = true, //是否能点击(动画未完成时不能点击)
            success = "", //拼图成功顺序
            eventHandler= ("touchstart" in document)?"touchstart":"click",//移动优先触摸事件
            tileArray = [];


        //生成成功数字串
        for (var i = 1; i <= gridSize * gridSize; i++) {
            success += "" + i;
        }

        function setLevel(level) {
            localStorage.setItem("level", level);
            return level;
        }

        function getLevel() {
            var level = localStorage.getItem("level");
            if (!level) {
                level = setLevel(1);
            }
            return parseInt(level);
        }

        //根据元素的index获取所在的位置
        function getPos(idx) {
            var y = Math.ceil((idx + 1) / gridSize - 1);
            var x = idx - gridSize * y;
            return {
                x: x,
                y: y
            };
        }

        function isSuccess() {
            var temp = ""; //判断移动格子后的顺序
            $container.find(".item>div").each(function(idx, item) {
                temp += $(item).data("index");
            });
            if (temp == success) {
                if (getLevel() < maxLevel) {
                    alert("恭喜你，通过了本关卡");
                    setLevel(getLevel() + 1);
                    initUI();
                } else {
                    alert("恭喜你，完成了所有拼图");
                }
                return true;
            }
            return false;
        }

        function initEvents() {
            function onEvent() {
                if (!canClick) {
                    return;
                }
                var $that = $(this),
                    $newEmpty = $that.parent();
                $empty = $(".empty"),
                    $newView = $empty.parent();

                //如果点击空
                if (!$that.hasClass("empty")) {
                    var pos = getPos($that.parent().index());
                    var x = pos.x;
                    var y = pos.y;
                    var canMove = false;
                    var moveTo;
                    //是否是空格式相邻的格子，只能是点击与空格子相邻的格子才交换位置
                    var moveVal = $that.outerWidth();
                    if (y == empty.y) {
                        if (x + 1 == empty.x) {
                            moveTo = {
                                left: moveVal
                            };
                        }
                        if (x - 1 == empty.x) {
                            moveTo = {
                                left: -moveVal
                            };
                        }

                    }
                    if (x == empty.x) {
                        if (y + 1 == empty.y) {
                            moveTo = {
                                top: moveVal
                            };
                        }
                        if (y - 1 == empty.y) {
                            moveTo = {
                                top: -moveVal
                            };
                        }
                    }
                    if (moveTo) {
                        canClick = false;
                        $empty.appendTo($newEmpty);
                        empty = {
                            x: x,
                            y: y
                        };
                        $newEmpty.css({
                            "z-index": "11"
                        });
                        $that.animate(moveTo, 100, function() {
                            canClick = true;
                            $newEmpty.attr("style", "");
                            $that.attr("style", "").appendTo($newView);
                            isSuccess();
                        })
                    }
                }
            }

            //处理格子点击事件
            $container.on(eventHandler, ".item>div", onEvent);
        }

        function initUI() {
            empty = {
                x: gridSize - 1,
                y: gridSize - 1
            };
            var levelText = "level" + getLevel();
            location.href = "#" + levelText;
            if ($("#container").length == 0) {
                //放到页面上去
                $container.appendTo($("body"));
            }
            $container.attr("class", "").addClass(levelText).empty();
            var index = 0;
            for (var i = 0; i <= empty.y; i++) {
                for (var j = 0; j <= empty.x; j++) {
                    index++;
                    var $point = $('<div class="item"><div class="pos-' + j + '-' + i + '" data-index="' + index + '"></div></div>');
                    $container.append($point);
                }
            }
            //将最后一个设置为empty 样式作为空格子
            $container.find(".item:last div").addClass("empty");

            //随机打乱顺序
            for (var i = 0; i < gridSize*gridSize; i++) {
                var number = Math.floor(Math.random() * (gridSize * gridSize-1));
                $container.find(".item:eq(" + number + ")").prependTo($container);
            }
            var temp = [];
            //判断移动格子后的顺序是否为偶排列，4*4的正常顺序为偶排列,一定要偶排列才能被还原，
            while (temp.length==0||inverNum(temp) % 2 != 0) {

                var number = Math.floor(Math.random() * (gridSize * gridSize - 1));

                $container.find(".item:eq(" + number + ")").prependTo($container);
                temp = [];

                $container.find(".item>div").each(function(idx, item) {
                    temp.push($(item).data("index"))
                });

            }
        }

        function inverNum(numArr) {
            var len = numArr.length;
            var count = 0;
            for (i = 0; i < len - 1; i++) {
                for (j = i + 1; j < len; j++) {
                    if (numArr[j] > numArr[i]) {
                        count++;
                    }
                }
            }
            return count;
        }

        //初始化游戏
        function initGame() {
            initEvents();
            //生成格子
            initUI();
        }

        $(function() {
            initGame();

            function setLevelUI(level) {
                if (level > 0 && level <= maxLevel) {
                    setLevel(level);
                    initUI();
                }
            }
            $("#reset").on(eventHandler,function(evt) {
                evt.preventDefault();
                setLevelUI(1);
            });

            $("#next").on(eventHandler,function(evt) {
                evt.preventDefault();
                setLevelUI(getLevel() + 1);
            });
            $("#prev").on(eventHandler,function(evt) {
                evt.preventDefault();
                setLevelUI(getLevel() - 1);
            });
        });

    });
</script>
</body>
</html>